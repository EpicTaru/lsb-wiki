== Executing a MySQL Query ==
Linux and Windows users with MySQL in their PATH can execute a query from the terminal using the following format:
```
mysql -u topaz -ppassword tpzdb -e "QUERY"
```
Where <b>topaz</b>, <b>password</b>, <b>tpzdb</b>, and <b>QUERY</b> are changed to your needs. Windows users can also use the query tab in HeidiSQL (default keybind is ctrl+t).

== Making a Game Master Character ==
After creating your first character you'll want to make it a GM by executing the following MySQL query, replacing <code>Name</code> with your character name:
```
UPDATE chars SET gmlevel = 4 WHERE charname = "Name";
```
Available commands are [https://github.com/topaz-next/topaz/tree/release/scripts/commands found in the scripts/commands/ folder], and a description of each command can be found at the top of the script. Commands can be used in-game using the script name with a preceding <code>!</code>, and removing <code>.lua</code>. For example, <code>promote.lua</code> is ran in game using <code>!promote</code>. This is the command you would use to make additional GMs.

== Changing Game Settings ==
Various details about the game can be changed via editing the settings files. Some settings are located in <code>topaz/conf/map.conf</code> and require a server reboot to apply. Other settings are found in <code>topaz/scripts/globals/settings.lua</code> and only require a GM command to reload, <code>!reloadglobal settings</code> (although some settings still require a reboot for full effect). Other files in the <code>topaz/scripts/globals/</code> folder can be changed in the same way.

== Changing the Server IP Address ==
To make the server accessible over a network, the zoneip must be changed in the zone_settings table. You can do this with a simple MySQL query.
```
UPDATE zone_settings SET zoneip = 'IP';
```
Replace <code>IP</code> with the desired IP. To access the game only on the same machine, this should be <code>127.0.0.1</code>. If you're accessing the server from another machine on the network, it should be the local IP address of the host, e.g. <code>192.168.0.11</code>. If you want to access it over the internet, it needs to be your public IP which can be gathered from various websites such as https://www.whatismyip.com/.

== Database Management ==
By default, dbtool will backup your whole database into <code>topaz/sql/backups/</code> whenever it performs an update. You can turn this off and do manual backups either with the TUI, or by running <code>python3 dbtool.py backup</code>. You can create a backup of only sensitive player data by using <code>python3 dbtool.py backup lite</code>. The tables it backs up with the <code>lite</code> argument are defined in <code>topaz/tools/config.yaml</code>. The backups can be imported using the <b>Restore/Import</b> command in dbtool.

== Auto-Starting the Server ==
Linux users can create several systemd services to automate the servers (make sure to update <code>/path/to/topaz</code>, and the User/Group):

```
#topaz.service

[Unit]
Description=Topaz - FFXI Server Emulator
After=mysql.service

[Service]
Type=oneshot
ExecStart=/bin/true
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
```

```
#topaz_game.service

[Unit]
Description=Topaz Game Server
Wants=network.target
StartLimitIntervalSec=120
StartLimitBurst=5
PartOf=topaz.service
After=topaz.service

[Service]
Type=simple
Restart=always
RestartSec=5
User=topaz
Group=topaz
WorkingDirectory=/path/to/topaz
# For multiple map servers:
# - Make a copy of this file for each server. Rename appropriately, e.g. topaz_game-cities.service
# - Add this to a file named ip.txt in the topaz folder, replacing YOUR_PUBLIC_IP with your IP: "IP=YOUR_PUBLIC_IP"
# - Change the zone ports in zone_settings table. A custom.sql file is useful for this.
# - Remove the line below, 'ExecStart=/path/to/topaz_game'.
# - Uncomment and edit the 2 lines below with the appropriate port and log location for each zone server.
#EnvironmentFile=/path/to/topaz/ip.txt
#ExecStart=/path/to/topaz/topaz_game --ip $IP --port 54230 --log /path/to/log/map_server.log
ExecStart=/path/to/topaz/topaz_game

[Install]
WantedBy=topaz.service
```

```
#topaz_connect.service

[Unit]
Description=Topaz Connect Server
Wants=network.target
StartLimitIntervalSec=120
StartLimitBurst=5
PartOf=topaz.service
After=topaz.service

[Service]
Type=simple
Restart=always
RestartSec=5
User=topaz
Group=topaz
WorkingDirectory=/path/to/topaz
ExecStart=/path/to/topaz/topaz_connect

[Install]
WantedBy=topaz.service
```

```
#topaz_search.service

[Unit]
Description=Topaz Search Server
Wants=network.target
StartLimitIntervalSec=120
StartLimitBurst=5
PartOf=topaz.service
After=topaz.service

[Service]
Type=simple
Restart=always
RestartSec=5
User=topaz
Group=topaz
WorkingDirectory=/path/to/topaz
ExecStart=/path/to/topaz/topaz_search

[Install]
WantedBy=topaz.service
```
After adding these the <code>/etc/systemd/system/</code>, run <code>systemctl daemon-reload</code> followed by <code>systemctl enable topaz_game topaz_connect topaz_search</code>. You can start/stop all the servers at once with <code>systemctl start/stop topaz</code> or each individual service separately. To enable auto-start, type <code>systemctl enable topaz</code>. Make sure topaz is in a location accessible to the user that will be running the service, and the correct permissions are set.

== See Also ==
[https://github.com/topaz-next/topaz/wiki/Useful-SQL-queries Useful SQL Queries]

[https://github.com/topaz-next/topaz/wiki/Miscellaneous-(Server) Common Issues and Tweaks]

[https://github.com/topaz-next/topaz/wiki/Debugging Debugging]